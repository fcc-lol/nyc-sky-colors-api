<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NYC Sky Colors</title>
    <style>
      body {
        font-family: monospace;
        margin: 0;
        padding: 1.25rem;
        background-color: #f0f0f0;
        min-height: calc(100vh - 2.5rem);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        max-width: 50rem;
        text-align: center;
        padding-bottom: 2rem;
      }

      #header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1.25rem;
        margin-bottom: 1.5rem;
      }

      h1 {
        font-size: 2rem;
        color: #333;
        margin: 0;
      }

      #timestamp {
        font-size: 1rem;
        color: #666;
      }

      #countdown {
        font-size: 0.875rem;
        color: #888;
        min-height: 1.125rem;
      }

      #grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
        margin: 2rem 0;
        justify-items: center;
      }

      .card {
        background: white;
        padding: 1rem;
        border-radius: 2rem;
        box-shadow: 0 0.125rem 1.25rem rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .color-swatch {
        display: block;
        width: 12rem;
        height: 12rem;
        border-radius: 1rem;
        margin: 0 auto 1rem auto;
        background-color: #e0e0e0;
      }

      .color-label {
        font-size: 1rem;
        font-weight: 500;
        text-transform: uppercase;
        color: #666;
        margin-top: 1.5rem;
      }

      .hex-code {
        font-weight: bold;
        color: #000;
        display: block;
        margin: 1rem 0 0.75rem 0;
        font-size: 2rem;
        text-transform: uppercase;
        min-height: 2.4rem;
      }

      #source-link {
        margin-top: 2rem;
        text-align: center;
      }

      #source-link a {
        color: #666;
        text-decoration: none;
        font-size: 0.875rem;
        border-bottom: 0.125rem solid #ccc;
        padding-bottom: 0.125rem;
        text-transform: uppercase;
      }

      #source-link a:hover {
        color: #333;
        border-bottom-color: #333;
      }

      /* Mobile responsive styles */
      @media (max-width: 1024px) {
        body {
          padding: 0;
          overflow-x: hidden;
        }

        .container {
          max-width: 100%;
          padding: 3rem 1rem;
        }

        h1 {
          font-size: 1.5rem;
        }

        #header {
          gap: 1rem;
          margin-bottom: 1rem;
        }

        #grid {
          grid-template-columns: 2fr 2fr;
          gap: 1.5rem;
          margin: 1.5rem -1rem;
          padding: 0;
          justify-items: center;
        }

        .hex-code {
          font-size: 1.5rem;
          min-height: 1.8rem;
        }
      }

      /* Extra small mobile devices */
      @media (max-width: 480px) {
        .container {
          width: 100%;
          padding: 2.5rem 1rem 3.5rem 1rem;
        }

        h1 {
          font-size: 1.25rem;
        }

        #grid {
          grid-template-columns: 1fr;
          width: calc(100% - 2rem);
        }

        .card {
          width: 100%;
        }

        .color-swatch {
          width: 100%;
          height: 6rem;
        }

        .hex-code {
          min-height: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="header">
        <h1>NEW YORK CITY SKY COLORS</h1>
        <div id="timestamp">Checking the sky...</div>
        <div id="countdown"></div>
      </div>
      <div id="grid">
        <div class="card">
          <div class="color-info">
            <div class="color-swatch" id="west-swatch"></div>
            <div class="color-label">West</div>
            <div class="hex-code" id="west-hex"></div>
          </div>
        </div>
        <div class="card">
          <div class="color-info">
            <div class="color-swatch" id="north-west-swatch"></div>
            <div class="color-label">North-West</div>
            <div class="hex-code" id="north-west-hex"></div>
          </div>
        </div>
        <div class="card">
          <div class="color-info">
            <div class="color-swatch" id="north-east-swatch"></div>
            <div class="color-label">North-East</div>
            <div class="hex-code" id="north-east-hex"></div>
          </div>
        </div>
        <div class="card">
          <div class="color-info">
            <div class="color-swatch" id="east-swatch"></div>
            <div class="color-label">East</div>
            <div class="hex-code" id="east-hex"></div>
          </div>
        </div>
      </div>
      <div id="source-link">
        <a href="#" id="source-url" target="_blank" rel="noopener"
          >View source</a
        >
        <span style="margin: 0 1rem; color: #ccc">|</span>
        <a
          href="/history"
          style="
            color: #666;
            text-decoration: none;
            font-size: 0.875rem;
            border-bottom: 0.125rem solid #ccc;
            padding-bottom: 0.125rem;
            text-transform: uppercase;
          "
          >History</a
        >
      </div>
    </div>

    <script>
      let countdownInterval;
      let nextUpdateTimestamp;
      let isHistoricalData = false;

      // Parse URL parameters
      function getUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const date = urlParams.get("date");
        const time = urlParams.get("time");

        // Return parameters if both exist, null otherwise
        if (date && time) {
          return { date, time };
        }

        return null;
      }

      function showError(message) {
        document.getElementById("timestamp").textContent = "Error: " + message;
        document.getElementById("countdown").textContent = "";
      }

      function formatTimeRemaining(milliseconds) {
        if (milliseconds <= 0) return "overdue";

        const totalSeconds = Math.floor(milliseconds / 1000);
        const minutes = Math.ceil(totalSeconds / 60);

        return (
          "Next update in " + minutes + " minute" + (minutes !== 1 ? "s" : "")
        );
      }

      function updateCountdown() {
        if (!nextUpdateTimestamp || isHistoricalData) return;

        const now = Date.now();
        const timeRemaining = nextUpdateTimestamp - now;

        const countdownElement = document.getElementById("countdown");

        if (timeRemaining <= 0) {
          const overdueSeconds = Math.floor(-timeRemaining / 1000);

          countdownElement.textContent = "Updating...";
          countdownElement.style.color = "#888";
          countdownElement.style.fontWeight = "normal";

          // Poll for new data every 5 seconds when update is due
          if (overdueSeconds % 5 === 0) {
            loadColors();
          }
        } else {
          countdownElement.textContent = formatTimeRemaining(timeRemaining);
          countdownElement.style.color = "#888";
          countdownElement.style.fontWeight = "normal";
        }
      }

      let lastDataTimestamp = null;

      async function loadColors() {
        try {
          // Get URL parameters
          const params = getUrlParameters();

          // Build API URL
          let apiUrl = "/api";
          if (params) {
            apiUrl += "?date=" + params.date + "&time=" + params.time;
          }

          const response = await fetch(apiUrl);
          const data = await response.json();

          // Handle API errors (let the API do all validation)
          if (data.error) {
            showError(data.message || data.error);
            return;
          }

          // Check if we have new data (for current data only)
          if (
            !isHistoricalData &&
            lastDataTimestamp &&
            data.metadata.lastUpdated.timestamp > lastDataTimestamp
          ) {
            console.log("New data available!");
          }

          // Store the timestamp of this data
          lastDataTimestamp = data.metadata.lastUpdated.timestamp;

          // Set color swatches and hex codes
          document.getElementById("west-swatch").style.backgroundColor =
            data.colors.west;
          document.getElementById("west-hex").textContent = data.colors.west;

          document.getElementById("north-west-swatch").style.backgroundColor =
            data.colors["north-west"];
          document.getElementById("north-west-hex").textContent =
            data.colors["north-west"];

          document.getElementById("north-east-swatch").style.backgroundColor =
            data.colors["north-east"];
          document.getElementById("north-east-hex").textContent =
            data.colors["north-east"];

          document.getElementById("east-swatch").style.backgroundColor =
            data.colors.east;
          document.getElementById("east-hex").textContent = data.colors.east;

          // Update timestamp info
          document.getElementById("timestamp").textContent =
            data.metadata.lastUpdated.formatted;

          // Update source link
          document.getElementById("source-url").href = data.metadata.source.url;

          // Check if this is historical data
          isHistoricalData = data.metadata.isHistoricalData;

          // Handle countdown based on data type
          if (isHistoricalData) {
            // For historical data, show that it's historical and don't show countdown
            document.getElementById("countdown").textContent =
              "Historical data";
            document.getElementById("countdown").style.color = "#666";

            // Clear any existing countdown interval
            if (countdownInterval) {
              clearInterval(countdownInterval);
              countdownInterval = null;
            }
          } else {
            // For current data, set up countdown timer
            nextUpdateTimestamp = data.metadata.nextUpdate
              ? data.metadata.nextUpdate.timestamp
              : null;

            // Clear existing countdown interval
            if (countdownInterval) {
              clearInterval(countdownInterval);
            }

            if (nextUpdateTimestamp) {
              // Update countdown immediately
              updateCountdown();

              // Start countdown timer that updates every second
              countdownInterval = setInterval(updateCountdown, 1000);
            } else {
              document.getElementById("countdown").textContent = "";
            }
          }
        } catch (error) {
          console.error("Error loading colors:", error);
          showError("Unable to load color data");
        }
      }

      // Load colors when page loads
      window.onload = loadColors;
    </script>
  </body>
</html>
